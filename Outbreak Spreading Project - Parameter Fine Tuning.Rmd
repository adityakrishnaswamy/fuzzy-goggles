---
title: "Outbreak Spreading Project - Parameter Fine Tuning"
author: "Aditya Krishnaswamy"
date: "2/12/2018"
output: pdf_document
---
##Data Cleaning
The following packages were used to merge the datasets from the World Bank and the dataset from the Smith et al. paper. The Smith et al. dataset contains a subset of the outbreak records available on the GIDEON network.
```{r}
library(readxl)
library(countrycode)
library(dplyr)
library(tidyr)
```

World Bank Data: The datasets were read in with readxl package. The merge function was used to merge the datasets. The country code package was used to have consistent naming conventions for the country name across datasets.
```{r}
Health_WorldBank_Data=read_xlsx("~/Documents/Research/Drake Lab/Data_Extract_From_Health_Nutrition_and_Population_Statistics.xlsx")
WDI_WorldBank_Data=read_xlsx("~/Documents/Research/Drake Lab/Data_Extract_From_World_Development_Indicators.xlsx")
WorldBank_Data=merge(Health_WorldBank_Data,WDI_WorldBank_Data,by=c("Country Name","Series Name","Series Code","Country Code", "1960 [YR1960]","1961 [YR1961]","1962 [YR1962]","1963 [YR1963]","1964 [YR1964]","1965 [YR1965]","1966 [YR1966]","1967 [YR1967]","1968 [YR1968]","1969 [YR1969]","1970 [YR1970]","1971 [YR1971]","1972 [YR1972]","1973 [YR1973]","1974 [YR1974]","1975 [YR1975]","1976 [YR1976]","1977 [YR1977]","1978 [YR1978]","1979 [YR1979]","1980 [YR1980]","1981 [YR1981]","1982 [YR1982]","1983 [YR1983]","1984 [YR1984]","1985 [YR1985]","1986 [YR1986]","1987 [YR1987]","1988 [YR1988]","1989 [YR1989]","1990 [YR1990]","1991 [YR1991]","1992 [YR1992]","1993 [YR1993]","1994 [YR1994]","1995 [YR1995]","1996 [YR1996]","1997 [YR1997]","1998 [YR1998]","1999 [YR1999]","2000 [YR2000]","2001 [YR2001]","2002 [YR2002]","2003 [YR2003]","2004 [YR2004]","2005 [YR2005]","2006 [YR2006]","2007 [YR2007]","2008 [YR2008]","2009 [YR2009]","2010 [YR2010]","2011 [YR2011]","2012 [YR2012]","2013 [YR2013]","2014 [YR2014]","2015 [YR2015]","2016 [YR2016]","2017 [YR2017]"),all=TRUE)
WorldBank_Data[['Country Name']]=countrycode(WorldBank_Data[['Country Name']],'country.name','iso3c')
write.csv(WorldBank_Data,"WorldBank_Data.csv")
```

With careful observation, many of the variables did not have sufficient data available, so these variables were removed. Additionally, many of the datasets were modified. The linked Google Doc describes how and which variables were removed and modified using Excel. The resulting Excel sheet was loaded using readxl package into the WorldBank_Data_Cleaned dataframe.
https://docs.google.com/document/d/1MnmXkzIH5mhZ7zqyzdCUDUYV_hOHTyehWayzNapsfKU/edit?usp=sharing

This dataframe contained every combination of country and series name in a different row. Each year's data was in a different column. Using the stack function, all of the columns of each year's data were merged into one column. The resulting dataframe contained one column of all the values ascribed to each combination of country and series. The second column contained the year connected with each value.
```{r}
WorldBank_Data_Cleaned=read_xlsx("~/Documents/Research/Drake Lab/WorldBank_Data_Modified.xlsx")
WorldBank_Data_Stacked=stack(WorldBank_Data_Cleaned,select=c("1960","1961","1962","1963","1964","1965","1966","1967","1968","1969","1970","1971","1972","1973","1974","1975","1976","1977","1978","1979","1980","1981","1982","1983","1984","1985","1986","1987","1988","1989","1990","1991","1992","1993","1994","1995","1996","1997","1998","1999","2000","2001","2002","2003","2004","2005","2006","2007","2008","2009","2010","2011","2012","2013","2014","2015","2016","2017"))
names(WorldBank_Data_Stacked)=c("Value","Year")
```

To merge the above dataset of values and years, a new dataframe was created with repetitions of country name, series name, and series code. This dataset was merged with the above dataset.
```{r}
numberOfYears=2017-1960+1 #number of years in dataset
WorldBank_Data_Series_Names=data.frame("Country Name"=rep(WorldBank_Data_Cleaned$`Country Name`,times=numberOfYears),
                                 "Series Name"=rep(WorldBank_Data_Cleaned$`Series Name`,times=numberOfYears),
                                 "Series Code"=rep(WorldBank_Data_Cleaned$`Series Code`,times=numberOfYears))
WorldBank_Data_Stacked=data.frame("Country Name"=WorldBank_Data_Series_Names$Country.Name,
                                  "Series Name"=WorldBank_Data_Series_Names$Series.Name,
                                  "Series Code"=WorldBank_Data_Series_Names$Series.Code,
                                  "Year"=WorldBank_Data_Stacked$Year,
                                  "Value"=WorldBank_Data_Stacked$Value)
```

The data from GIDEON was read into GIDEON_Outbreak_Data_Smith dataframe using readxl package. The nation names were converted using country code package to match the country names in the World Bank data.
```{r}
GIDEON_Outbreak_Data_Smith=read_xlsx("~/Documents/Research/Drake Lab/SmithEtAl_outbreakdata.xlsx")
GIDEON_Outbreak_Data_Smith[['Nation']]=countrycode(GIDEON_Outbreak_Data_Smith[['Nation']],'country.name','iso3c')
```

The GIDEON data and World Bank data were merged using merge function, matching by country and year. The data was then spread using tidyr package so the resulting dataset has one row ascribed to each outbreak event with information on the pathogen and demographic and socioeconomic characteristics of the country in which the outbreak event occurred. All rows with missing values for total number of cases in the outbreak event were removed.
```{r}
GIDEON_WorldBank_Data=merge(GIDEON_Outbreak_Data_Smith,WorldBank_Data_Stacked,by.x = c("Nation","Year"),by.y = c("Country.Name","Year"),all=FALSE)
GIDEON_WorldBank_Data=unite(GIDEON_WorldBank_Data,Series.Name:Series.Code,Series.Name,Series.Code,sep=": ")
GIDEON_WorldBank_Data=spread(GIDEON_WorldBank_Data,"Series.Name:Series.Code","Value")
GIDEON_WorldBank_Data_1=GIDEON_WorldBank_Data[is.na(GIDEON_WorldBank_Data$`Total Cases`)==FALSE,]
```


###Packages
A random seed was set to allow reproducability of these resuts. The GBM package for machine learning and caTools package was loaded into R.
```{r, echo=TRUE}
randomSeed=3493
set.seed(randomSeed)
library(gbm)
library(caTools)
library(caret)
```

###Variable Conversion
Response variable converted to logarithmic scale.
```{r}
GIDEON_WorldBank_Data_1$logCases=log10(GIDEON_WorldBank_Data_1[['Total Cases']])
```

Categorical Variables were converted from numerical data type to categorical type: transmission type, host type, pathogen taxonomy
```{r}
GIDEON_WorldBank_Data_1[['Transmission Type']]=factor(GIDEON_WorldBank_Data_1[['Transmission Type']],levels = c(0,1),labels = c("Nonvectorborne","Vectorborne"))
GIDEON_WorldBank_Data_1[['Host Type']]=factor(GIDEON_WorldBank_Data_1[['Host Type']],levels = c(0,1),labels = c("Zoonoses","Human Specific"))
GIDEON_WorldBank_Data_1[['Pathogen Taxonomy']]=factor(GIDEON_WorldBank_Data_1[['Pathogen Taxonomy']],levels = c(1,2,3,4,5),labels = c("Bacteria","Virus","Protozoan","Parasite","Fungi"))
```

The following columns were removed: Nation, Year, UID, Disease, and Total Cases. These were removed because they are not going to be used in the gradient boosting machine.
```{r}
GIDEON_WorldBank_Data_2=GIDEON_WorldBank_Data_1[,-c(1,2,3,4,5,10:20,24:31,33,36,37,43:47,51,52,54,55,56:63,66,67,69,70,72,73,75,76)]
```

###Training and Testing Data Split
30% of the data was set aside for testing the model after model training. The rest will be used during model training. Unnecessary columns were removed from the data frames.
```{r}
split = sample.split(GIDEON_WorldBank_Data_2[,1], SplitRatio=0.7)
GIDEON_WorldBank_Data_2$split = split
trainingData=subset(GIDEON_WorldBank_Data_2,split==TRUE)
testingData=subset(GIDEON_WorldBank_Data_2,split==FALSE)
trainingData=trainingData[,-c(36)]
testingData=testingData[,-c(36)]
```

###GBM Modeling

The caret package was used to tune the gbm model. 5 repeats were done of a 10-fold cross validation for the outbreak dataset.
```{r}
set.seed(1335)
trainctrl=trainControl(method="repeatedcv",number=10,repeats=5)
```

The model was first trained using caret package's built-in parameters for gradient boosting machine. A Gaussian distribution was used to produce a mean squared error loss function. This loss function can be used as a function of the model's prediction errors. With a lower mean squared error, the model better predicts outputs with less error or variation. The spread of the logarithm of the total cases in outbreak events appears to have a normal distribution, with a unimodal peak and no significant skew. This allows us to use the Gaussian distribution.
```{r}
TrainData=trainingData[,35]
TrainClass=trainingData[,-c(35)]
gbm_tree_auto=train(TrainClass,y=TrainData,method="gbm",distribution="gaussian",trControl=trainctrl,verbose=FALSE)
gbm_tree_auto
```

Below, are the parameters used for tuning of the gbm model.
```{r}
getModelInfo()$gbm$parameters
```

We expand a grid to include more combinations of the tuning parameters. Evidenced by the the low correlation coefficient with the auto-tuning parameters, with a maximum of 150 trees, the model poorly predicts the number of cases in an outbreak event. The expanded grid tests the model with 2500, 5000, and 10000 trees. Interaction depth is the number of splits the algorithm performs on each tree. We test interaction depths from 3 to 10.
```{r}
myGrid=expand.grid(n.trees=c(500,2500,7500),
                   interaction.depth=c(3,6,7,9),
                   shrinkage=c(.01,.1,.2),
                   n.minobsinnode=c(7,12,20))
gbm_tree_tune=train(TrainClass,y=TrainData,method="gbm",distribution="gaussian",trControl=trainctrl,verbose=FALSE,tuneGrid=myGrid)
gbm_tree_tune
```

The plot function can be used to examine the relationship between the estimates of performance and the tuning parameters.
```{r}
plot(gbm_tree_tune)
```

Below are the tuning parameters of the best performing GBM model.
```{r}
gbm_tree_tune$bestTune
```

The final GBM model is trained using the best tuning parameters.
```{r}
myGrid_Adjusted=gbm_tree_tune$bestTune
gbm_tree=train(TrainClass,y=TrainData,method="gbm",distribution="gaussian",trControl=trainctrl,verbose=FALSE,tuneGrid=myGrid_Adjusted)
gbm_tree
```

The comparison below shows the relative influence of the top 20 features when the "best" tuning parameters are used.
```{r}
varImp(gbm_tree)
plot(varImp(gbm_tree),top=20)
```